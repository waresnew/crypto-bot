{"version":3,"sources":["../../src/api/cmcApi.ts"],"sourcesContent":["import { CronJob } from \"cron\";\nimport { WebhookClient } from \"discord.js\";\nimport fetch from \"node-fetch\";\nimport { db, genSqlInsertCommand } from \"../database.js\";\nimport { cryptoSymbolList } from \"../globals.js\";\nimport { CryptoApiData } from \"../structs/cryptoapidata.js\";\nexport async function initApiCrons() {\n    new CronJob(\n        \"*/5 * * * *\",\n        async () => {\n            const request = await fetch(\n                \"https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest?\" +\n                new URLSearchParams({\n                    limit: \"200\"\n                }),\n                {\n                    method: \"get\",\n                    headers: {\n                        \"X-CMC_PRO_API_KEY\": process.env[\"COINMARKETCAP_KEY\"],\n                        Accept: \"application/json\",\n                        \"Accept-Encoding\": \"deflate, gzip\",\n                        \"Content-Type\": \"application/json\"\n                    }\n                }\n            );\n            const json = JSON.parse(await request.text());\n            const errorCode = json.status.error_code;\n            if (errorCode != 0) {\n                new WebhookClient({ url: process.env[\"LOG_WEBHOOK\"] }).send(`Error code ${errorCode} from the CoinMarketCap API occured at ${json.status.timestamp}`);\n            }\n            await db.run(\"begin\");\n            await db.run(\"delete from cmc_cache\");\n            cryptoSymbolList.length = 0;\n            for (let i = 0; i < 200; i++) {\n                const data = { ...json.data[i], ...json.data[i].quote.USD } as CryptoApiData;\n                cryptoSymbolList.push(data.symbol);\n                genSqlInsertCommand(data, \"cmc_cache\", new CryptoApiData());\n            }\n            await db.run(\"commit\");\n            console.log(`Updated caches at ${new Date().toString()}`);\n        },\n        null,\n        true,\n        \"America/Toronto\"\n    );\n}\n\n"],"names":["CronJob","WebhookClient","fetch","db","genSqlInsertCommand","cryptoSymbolList","CryptoApiData","initApiCrons","request","URLSearchParams","limit","method","headers","process","env","Accept","json","JSON","parse","text","errorCode","status","error_code","url","send","timestamp","run","length","i","data","quote","USD","push","symbol","console","log","Date","toString"],"mappings":"AAAA,SAASA,OAAO,QAAQ,OAAO;AAC/B,SAASC,aAAa,QAAQ,aAAa;AAC3C,OAAOC,WAAW,aAAa;AAC/B,SAASC,EAAE,EAAEC,mBAAmB,QAAQ,iBAAiB;AACzD,SAASC,gBAAgB,QAAQ,gBAAgB;AACjD,SAASC,aAAa,QAAQ,8BAA8B;AAC5D,OAAO,eAAeC,eAAe;IACjC,IAAIP,QACA,eACA,UAAY;QACR,MAAMQ,UAAU,MAAMN,MAClB,yEACA,IAAIO,gBAAgB;YAChBC,OAAO;QACX,IACA;YACIC,QAAQ;YACRC,SAAS;gBACL,qBAAqBC,QAAQC,GAAG,CAAC,oBAAoB;gBACrDC,QAAQ;gBACR,mBAAmB;gBACnB,gBAAgB;YACpB;QACJ;QAEJ,MAAMC,OAAOC,KAAKC,KAAK,CAAC,MAAMV,QAAQW,IAAI;QAC1C,MAAMC,YAAYJ,KAAKK,MAAM,CAACC,UAAU;QACxC,IAAIF,aAAa,GAAG;YAChB,IAAInB,cAAc;gBAAEsB,KAAKV,QAAQC,GAAG,CAAC,cAAc;YAAC,GAAGU,IAAI,CAAC,CAAC,WAAW,EAAEJ,UAAU,uCAAuC,EAAEJ,KAAKK,MAAM,CAACI,SAAS,CAAC,CAAC;QACxJ,CAAC;QACD,MAAMtB,GAAGuB,GAAG,CAAC;QACb,MAAMvB,GAAGuB,GAAG,CAAC;QACbrB,iBAAiBsB,MAAM,GAAG;QAC1B,IAAK,IAAIC,IAAI,GAAGA,IAAI,KAAKA,IAAK;YAC1B,MAAMC,OAAO;gBAAE,GAAGb,KAAKa,IAAI,CAACD,EAAE;gBAAE,GAAGZ,KAAKa,IAAI,CAACD,EAAE,CAACE,KAAK,CAACC,GAAG;YAAC;YAC1D1B,iBAAiB2B,IAAI,CAACH,KAAKI,MAAM;YACjC7B,oBAAoByB,MAAM,aAAa,IAAIvB;QAC/C;QACA,MAAMH,GAAGuB,GAAG,CAAC;QACbQ,QAAQC,GAAG,CAAC,CAAC,kBAAkB,EAAE,IAAIC,OAAOC,QAAQ,GAAG,CAAC;IAC5D,GACA,IAAI,EACJ,IAAI,EACJ;AAER,CAAC"}