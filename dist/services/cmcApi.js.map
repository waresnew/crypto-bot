{"version":3,"sources":["../../src/services/cmcApi.ts"],"sourcesContent":["import {CronJob} from \"cron\";\nimport {chatInputApplicationCommandMention, Client} from \"discord.js\";\nimport fetch from \"node-fetch\";\nimport {db, genSqlInsertCommand} from \"../database.js\";\nimport {alertDevs, cryptoSymbolList} from \"../utils.js\";\nimport {CryptoApiData} from \"../structs/cryptoapidata.js\";\nimport {UserSetting, UserSettingType} from \"../structs/usersettings.js\";\nimport CryptoStat from \"../structs/cryptoStat.js\";\nimport {formatAlert} from \"../ui/alerts/interfaceCreator.js\";\nimport {getEmbedTemplate} from \"../ui/templates.js\";\n\nlet client: Client;\n\nexport function initClient(c: Client) {\n    client = c;\n}\n\nnew CronJob(\n    \"*/5 * * * *\",\n    updateCmc,\n    null,\n    true,\n    \"America/Toronto\"\n);\n\nexport async function updateCmc() {\n    const request = await fetch(\n        \"https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest?\" +\n        new URLSearchParams({\n            limit: \"200\"\n        }),\n        {\n            method: \"get\",\n            headers: {\n                \"X-CMC_PRO_API_KEY\": process.env[\"COINMARKETCAP_KEY\"],\n                Accept: \"application/json\",\n                \"Accept-Encoding\": \"deflate, gzip\",\n                \"Content-Type\": \"application/json\"\n            }\n        }\n    );\n    const json = JSON.parse(await request.text());\n    const errorCode = json.status.error_code;\n    if (errorCode != 0) {\n        await alertDevs(`Error code ${errorCode} from the CoinMarketCap API occured at ${json.status.timestamp}`);\n        return;\n    }\n    await db.run(\"begin\");\n    await db.run(\"delete from cmc_cache\");\n    cryptoSymbolList.length = 0;\n    for (let i = 0; i < 200; i++) {\n        const data = {...json.data[i], ...json.data[i][\"quote\"][\"USD\"]} as CryptoApiData;\n        cryptoSymbolList.push(data.symbol);\n        await genSqlInsertCommand(data, \"cmc_cache\", new CryptoApiData());\n    }\n    await db.run(\"commit\");\n    console.log(`Updated caches at ${new Date().toString()}`);\n    await notifyUsers();\n    console.log(\"Sent alerts\");\n}\n\nasync function notifyUsers() {\n    const cache: CryptoApiData[] = await db.all(\"select * from cmc_cache\");\n    const alerts: UserSetting[] = await db.all(\"select id,alertToken,alertStat,alertThreshold,alertDirection,alertDisabled from user_settings where type=?\", UserSettingType[UserSettingType.ALERT]);\n    const toDm = new Map<string, string[]>();\n    for (const crypto of cache) {\n        for (const alert of alerts) {\n            if (alert.alertToken != crypto.id) {\n                continue;\n            }\n            if (alert.alertDisabled) {\n                continue;\n            }\n            const expr = crypto[CryptoStat.shortToDb(alert.alertStat)] + alert.alertDirection + alert.alertThreshold;\n            if (!new RegExp(/^[\\d-.e<>]+$/).test(expr)) { //match num>num or num<num\n                await alertDevs(`Potentially malicious code almost ran: \\`${expr}\\``);\n                continue;\n            }\n            if (eval(expr)) {\n                if (!toDm.has(alert.id)) {\n                    toDm.set(alert.id, []);\n                }\n                toDm.get(alert.id).push(await formatAlert(alert));\n                await db.run(\"update user_settings set alertDisabled=1 where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=?\", alert.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection);\n            }\n        }\n    }\n    for (const user of toDm.keys()) {\n        const notifs = toDm.get(user);\n        const message = getEmbedTemplate(client).setTitle(`⚠️ Alert${notifs.length > 1 ? \"s\" : \"\"} triggered!`);\n        let desc = `The following alert${notifs.length > 1 ? \"s have\" : \" has\"} been triggered:\\n`;\n        notifs.forEach((line) => {\n            desc += \"\\n- \" + line;\n        });\n        desc += `\\n\\nThe above alert${notifs.length > 1 ? \"s have\" : \" has\"} been **disabled** and won't trigger again until you re-enable ${notifs.length > 1 ? \"them\" : \"it\"} at ${chatInputApplicationCommandMention(\"alerts\", (await client.application.commands.fetch()).find(command => command.name == \"alerts\").id)}.\\n\\nHappy trading!`;\n        message.setDescription(desc);\n        await (await client.users.fetch(user)).send({embeds: [message]});\n    }\n}"],"names":["CronJob","chatInputApplicationCommandMention","fetch","db","genSqlInsertCommand","alertDevs","cryptoSymbolList","CryptoApiData","UserSettingType","CryptoStat","formatAlert","getEmbedTemplate","client","initClient","c","updateCmc","request","URLSearchParams","limit","method","headers","process","env","Accept","json","JSON","parse","text","errorCode","status","error_code","timestamp","run","length","i","data","push","symbol","console","log","Date","toString","notifyUsers","cache","all","alerts","ALERT","toDm","Map","crypto","alert","alertToken","id","alertDisabled","expr","shortToDb","alertStat","alertDirection","alertThreshold","RegExp","test","eval","has","set","get","user","keys","notifs","message","setTitle","desc","forEach","line","application","commands","find","command","name","setDescription","users","send","embeds"],"mappings":"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"}