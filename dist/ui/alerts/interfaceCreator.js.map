{"version":3,"sources":["../../../src/ui/alerts/interfaceCreator.ts"],"sourcesContent":["import {\r\n    ActionRowBuilder,\r\n    BaseInteraction,\r\n    ButtonBuilder,\r\n    ButtonStyle,\r\n    Client,\r\n    SelectMenuComponentOptionData,\r\n    StringSelectMenuBuilder\r\n} from \"discord.js\";\r\nimport {UserSetting, UserSettingType} from \"../../structs/usersettings.js\";\r\nimport {db, idToApiData} from \"../../database.js\";\r\nimport {getEmbedTemplate} from \"../templates.js\";\r\nimport CryptoStat from \"../../structs/cryptoStat.js\";\r\n\r\nexport async function makeAlertsMenu(interaction: BaseInteraction) {\r\n    const alerts: UserSetting[] = [];\r\n    const alertMenuOptions: SelectMenuComponentOptionData[] = [];\r\n    await db.each(\"select alertToken,alertStat,alertThreshold,alertDirection,alertDisabled from user_settings where type=? and id=?\", UserSettingType[UserSettingType.ALERT], interaction.user.id, (err, row) => {\r\n        if (err) {\r\n            throw err;\r\n        }\r\n        alerts.push(row as UserSetting);\r\n    });\r\n    for (const alert of alerts) {\r\n        const fancyStat = CryptoStat.shortToLong(alert.alertStat);\r\n        alertMenuOptions.push({\r\n            label: `${alert.alertDisabled ? \"❌\" : \"✅\"} ${fancyStat.charAt(0).toUpperCase() + fancyStat.substring(1)} of ${(await idToApiData(alert.alertToken)).name}`,\r\n            description: (alert.alertDirection == \"<\" ? \"Less than \" : \"Greater than \") + (alert.alertStat == \"price\" ? \"$\" : \"\") + alert.alertThreshold + (alert.alertStat.endsWith(\"%\") ? \"%\" : \"\"),\r\n            value: `${alert.alertToken}_${alert.alertStat}_${alert.alertThreshold}_${alert.alertDirection}_${alert.alertDisabled}`\r\n        });\r\n    }\r\n    alertMenuOptions.sort((a, b) => a.label.localeCompare(b.label));\r\n    return new ActionRowBuilder<StringSelectMenuBuilder>()\r\n        .addComponents(new StringSelectMenuBuilder()\r\n            .setCustomId(`alerts_menu_${interaction.user.id}`)\r\n            .setMinValues(1)\r\n            .setMaxValues(alertMenuOptions.length == 0 ? 1 : alertMenuOptions.length)\r\n            .setPlaceholder(\"Select one or more alerts...\")\r\n            .setOptions(alertMenuOptions.length > 0 ? alertMenuOptions : [{\r\n                label: \"You have no alerts.\",\r\n                value: \"default\"\r\n            }]));\r\n}\r\n\r\nexport function parseAlertId(id: string) {\r\n    const alert = new UserSetting();\r\n    const tokens = id.split(\"_\");\r\n    alert.alertToken = Number(tokens[0]);\r\n    alert.alertStat = tokens[1];\r\n    alert.alertThreshold = Number(tokens[2]);\r\n    alert.alertDirection = tokens[3];\r\n    alert.alertDisabled = Number(tokens[4]);\r\n    alert.id = tokens[5];\r\n    return alert;\r\n}\r\n\r\nexport async function makeEmbed(values: string[] | UserSetting[], interaction: BaseInteraction) {\r\n    const instructions = getEmbedTemplate(interaction.client)\r\n        .setTitle(\"Your alerts\");\r\n    let desc = \"Toggle/delete your crypto notifications here. Disabled notifications are marked with an ❌ and enabled notifications are marked with a ✅.\";\r\n    const choices: string[] = [];\r\n    let removed = \"\\n\\nThe following alerts no longer exist. They will not be processed.\\n\";\r\n    for (const value of values) {\r\n        let alert = new UserSetting();\r\n        if (values.length > 0 && typeof values[0] == \"string\") {\r\n            alert = parseAlertId(value as string);\r\n        } else {\r\n            alert = value as UserSetting;\r\n        }\r\n        if (!Object.values(await db.get(\"select exists(select 1 from user_settings where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=? and alertDisabled=?)\", interaction.user.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection, alert.alertDisabled))[0]) {\r\n            removed += \"\\n- \" + await formatAlert(alert);\r\n        } else {\r\n            choices.push(`${alert.alertDisabled ? \"❌\" : \"✅\"} ${await formatAlert(alert)}`);\r\n        }\r\n\r\n    }\r\n    if (removed != \"\\n\\nThe following alerts no longer exist. They will not be processed.\\n\") {\r\n        desc += removed;\r\n    }\r\n    choices.sort();\r\n    if (choices.length > 0) {\r\n        desc += \"\\n\\n **Selected:**\";\r\n    } else {\r\n        desc += \"\\n\\nYou currently have no selected alerts.\";\r\n    }\r\n    for (const val of choices) {\r\n        const addition = \"\\n- \" + val;\r\n        if (desc.length + addition.length > 4096) {\r\n            desc += \"...\";\r\n            break;\r\n        }\r\n        desc += addition;\r\n    }\r\n    instructions.setDescription(desc);\r\n    return instructions;\r\n}\r\n\r\nexport function makeButtons(interaction: BaseInteraction) {\r\n    return new ActionRowBuilder<ButtonBuilder>()\r\n        .addComponents(new ButtonBuilder()\r\n            .setCustomId(`alerts_enable_${interaction.user.id}`)\r\n            .setLabel(\"Enable selected\")\r\n            .setStyle(ButtonStyle.Success))\r\n        .addComponents(new ButtonBuilder()\r\n            .setCustomId(`alerts_disable_${interaction.user.id}`)\r\n            .setLabel(\"Disable selected\")\r\n            .setStyle(ButtonStyle.Secondary))\r\n        .addComponents(new ButtonBuilder()\r\n            .setCustomId(`alerts_delete_${interaction.user.id}`)\r\n            .setLabel(\"Delete selected\")\r\n            .setStyle(ButtonStyle.Danger));\r\n}\r\n\r\nexport async function formatAlert(alert: UserSetting) {\r\n    const fancyStat = CryptoStat.shortToLong(alert.alertStat);\r\n    return `When ${fancyStat} of ${(await idToApiData(alert.alertToken)).name} is ${alert.alertDirection == \"<\" ? \"less than\" : \"greater than\"} ${(alert.alertStat == \"price\" ? \"$\" : \"\") + alert.alertThreshold + (alert.alertStat.endsWith(\"%\") ? \"%\" : \"\")}`;\r\n}"],"names":["ActionRowBuilder","ButtonBuilder","ButtonStyle","StringSelectMenuBuilder","UserSetting","UserSettingType","db","idToApiData","getEmbedTemplate","CryptoStat","makeAlertsMenu","interaction","alerts","alertMenuOptions","each","ALERT","user","id","err","row","push","alert","fancyStat","shortToLong","alertStat","label","alertDisabled","charAt","toUpperCase","substring","alertToken","name","description","alertDirection","alertThreshold","endsWith","value","sort","a","b","localeCompare","addComponents","setCustomId","setMinValues","setMaxValues","length","setPlaceholder","setOptions","parseAlertId","tokens","split","Number","makeEmbed","values","instructions","client","setTitle","desc","choices","removed","Object","get","formatAlert","val","addition","setDescription","makeButtons","setLabel","setStyle","Success","Secondary","Danger"],"mappings":"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"}