{"version":3,"sources":["../../../src/ui/alerts/interactionProcessor.ts"],"sourcesContent":["import InteractionProcessor from \"../abstractInteractionProcessor.js\";\nimport {\n    ButtonInteraction,\n    chatInputApplicationCommandMention,\n    MessageComponentInteraction,\n    StringSelectMenuInteraction\n} from \"discord.js\";\nimport {UserSetting, UserSettingType} from \"../../structs/usersettings.js\";\nimport {db} from \"../../database.js\";\nimport {makeAlertsMenu, makeButtons, makeEmbed} from \"./interfaceCreator.js\";\nimport CryptoStat from \"../../structs/cryptoStat.js\";\n\nexport default class AlertsInteractionProcessor extends InteractionProcessor {\n    static override async processStringSelect(interaction: StringSelectMenuInteraction) {\n        if (interaction.customId.startsWith(\"alerts_menu\")) {\n            if (interaction.values[0] == \"default\") {\n                await interaction.reply({\n                    content: `Error: You have not set any alerts. Please set one with ${chatInputApplicationCommandMention(\"coin\", (await interaction.client.application.commands.fetch()).find(command => command.name == \"coin\").id)\n                    } before proceeding.`,\n                    ephemeral: true\n                });\n                return;\n            }\n\n            const instructions = await makeEmbed(interaction.values, interaction);\n\n            await interaction.update({\n                embeds: [instructions],\n                components: [await makeAlertsMenu(interaction), await makeButtons(interaction)]\n            });\n\n        }\n    }\n\n    static override async processButton(interaction: ButtonInteraction) {\n        const selected = await AlertsInteractionProcessor.parseSelected(interaction);\n        if (interaction.customId.startsWith(\"alerts_enable\")) {\n            for (const alert of selected) {\n                alert.alertDisabled = 0;\n                await db.run(\"update user_settings set alertDisabled=0 where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=?\", interaction.user.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection);\n            }\n        } else if (interaction.customId.startsWith(\"alerts_disable\")) {\n            for (const alert of selected) {\n                alert.alertDisabled = 1;\n                await db.run(\"update user_settings set alertDisabled=1 where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=?\", interaction.user.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection);\n            }\n        } else if (interaction.customId.startsWith(\"alerts_delete\")) {\n            for (const alert of selected) {\n                await db.run(\"delete from user_settings where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=?\", interaction.user.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection);\n            }\n            selected.length = 0;\n        }\n        await interaction.update({\n            embeds: [await makeEmbed(selected, interaction)],\n            components: [await makeAlertsMenu(interaction), await makeButtons(interaction)]\n        });\n    }\n\n    static async parseSelected(interaction: MessageComponentInteraction) {\n        const selected: UserSetting[] = [];\n        for (const line of interaction.message.embeds[0].description.split(\"\\n\")) {\n            const input = line.match(new RegExp(/- ([❌✅]) When (.+) of (.+) is (less|greater) than (.+)/));\n            if (!input) {\n                continue;\n            }\n            const setting = new UserSetting();\n            setting.id = interaction.user.id;\n            // eslint-disable-next-line @typescript-eslint/no-unused-vars\n            setting.alertStat = CryptoStat.longToShort(CryptoStat.listLongs().find(k => k == input[2].toLowerCase()));\n            setting.alertToken = (await db.get(\"select id from cmc_cache where name=?\", input[3])).id;\n            setting.alertThreshold = Number(input[5].replace(new RegExp(/[$%]/), \"\"));\n            setting.alertDirection = input[4] == \"less\" ? \"<\" : \">\";\n            setting.alertDisabled = input[1] == \"❌\" ? 1 : 0;\n            setting.type = UserSettingType[UserSettingType.ALERT];\n            selected.push(setting);\n        }\n        return selected;\n    }\n}"],"names":["InteractionProcessor","chatInputApplicationCommandMention","UserSetting","UserSettingType","db","makeAlertsMenu","makeButtons","makeEmbed","CryptoStat","AlertsInteractionProcessor","processStringSelect","interaction","customId","startsWith","values","reply","content","client","application","commands","fetch","find","command","name","id","ephemeral","instructions","update","embeds","components","processButton","selected","parseSelected","alert","alertDisabled","run","user","ALERT","alertToken","alertStat","alertThreshold","alertDirection","length","line","message","description","split","input","match","RegExp","setting","longToShort","listLongs","k","toLowerCase","get","Number","replace","type","push"],"mappings":"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"}