{"version":3,"sources":["../../../src/ui/alerts/interactionProcessor.ts"],"sourcesContent":["import InteractionProcessor from \"../abstractInteractionProcessor.js\";\nimport {\n    ButtonInteraction,\n    chatInputApplicationCommandMention,\n    MessageComponentInteraction,\n    StringSelectMenuInteraction\n} from \"discord.js\";\nimport {UserSetting, UserSettingType} from \"../../structs/usersettings.js\";\nimport {db} from \"../../database.js\";\nimport {makeAlertsMenu, makeButtons, makeEmbed} from \"./interfaceCreator.js\";\nimport CryptoStat from \"../../structs/cryptoStat.js\";\n\nexport default class AlertsInteractionProcessor extends InteractionProcessor {\n    static override async processStringSelect(interaction: StringSelectMenuInteraction) {\n        if (interaction.customId.startsWith(\"alerts_menu\")) {\n            if (interaction.values[0] == \"default\") {\n                await interaction.reply({\n                    content: `You have not set any alerts. Please set one with ${chatInputApplicationCommandMention(\"coin\", (await interaction.client.application.commands.fetch()).find(command => command.name == \"coin\").id)\n                    } before proceeding.`,\n                    ephemeral: true\n                });\n                return;\n            }\n            const instructions = await makeEmbed(interaction.values, interaction.client);\n            await interaction.update({embeds: [instructions], components: interaction.message.components});\n        }\n    }\n\n    static override async processButton(interaction: ButtonInteraction) {\n        const selected = await AlertsInteractionProcessor.parseSelected(interaction);\n        if (interaction.customId.startsWith(\"alerts_enable\")) {\n            for (const alert of selected) {\n                alert.alertDisabled = 0;\n                await db.run(\"update user_settings set alertDisabled=0 where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=?\", interaction.user.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection);\n            }\n        } else if (interaction.customId.startsWith(\"alerts_disable\")) {\n            for (const alert of selected) {\n                alert.alertDisabled = 1;\n                await db.run(\"update user_settings set alertDisabled=1 where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=?\", interaction.user.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection);\n            }\n        } else if (interaction.customId.startsWith(\"alerts_delete\")) {\n            for (const alert of selected) {\n                await db.run(\"delete from user_settings where id=? and type=? and alertToken=? and alertStat=? and alertThreshold=? and alertDirection=?\", interaction.user.id, UserSettingType[UserSettingType.ALERT], alert.alertToken, alert.alertStat, alert.alertThreshold, alert.alertDirection);\n            }\n            selected.length = 0;\n        }\n        await interaction.update({\n            embeds: [await makeEmbed(selected, interaction.client)],\n            components: [await makeAlertsMenu(interaction), await makeButtons(interaction)]\n        });\n    }\n\n    static async parseSelected(interaction: MessageComponentInteraction) {\n        const selected: UserSetting[] = [];\n        for (const line of interaction.message.embeds[0].description.split(\"\\n\")) {\n            const input = line.match(new RegExp(/- ([❌✅]) When (.+) of (.+) is (less|greater) than (.+)/));\n            if (!input) {\n                continue;\n            }\n            const setting = new UserSetting();\n            setting.id = interaction.user.id;\n            // eslint-disable-next-line @typescript-eslint/no-unused-vars\n            setting.alertStat = CryptoStat.longToShort(CryptoStat.listLongs().find(k => k == input[2].toLowerCase()));\n            setting.alertToken = (await db.get(\"select id from cmc_cache where name=?\", input[3])).id;\n            setting.alertThreshold = Number(input[5].replace(new RegExp(/[$%]/), \"\"));\n            setting.alertDirection = input[4] == \"less\" ? \"<\" : \">\";\n            setting.alertDisabled = input[1] == \"❌\" ? 1 : 0;\n            setting.type = UserSettingType[UserSettingType.ALERT];\n            selected.push(setting);\n        }\n        return selected;\n    }\n}"],"names":["InteractionProcessor","chatInputApplicationCommandMention","UserSetting","UserSettingType","db","makeAlertsMenu","makeButtons","makeEmbed","CryptoStat","AlertsInteractionProcessor","processStringSelect","interaction","customId","startsWith","values","reply","content","client","application","commands","fetch","find","command","name","id","ephemeral","instructions","update","embeds","components","message","processButton","selected","parseSelected","alert","alertDisabled","run","user","ALERT","alertToken","alertStat","alertThreshold","alertDirection","length","line","description","split","input","match","RegExp","setting","longToShort","listLongs","k","toLowerCase","get","Number","replace","type","push"],"mappings":"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"}