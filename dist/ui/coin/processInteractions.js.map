{"version":3,"sources":["../../../src/ui/coin/processInteractions.ts"],"sourcesContent":["import { ModalSubmitInteraction, chatInputApplicationCommandMention, ActionRowBuilder, ButtonBuilder, ButtonInteraction, ButtonStyle, ModalBuilder, StringSelectMenuBuilder, TextInputBuilder, TextInputStyle, APIButtonComponentWithCustomId } from \"discord.js\";\nimport { whatOptions } from \"../../globals.js\";\nimport { db, genSqlInsertCommand } from \"../../database.js\";\nimport { CryptoApiData } from \"../../structs/cryptoapidata.js\";\nimport { UserSetting, UserSettingType } from \"../../structs/usersettings.js\";\nimport { editComponents } from \"../editComponents.js\";\nimport { genFavouritesMenu } from \"./createInterfaces.js\";\n\nexport async function processModals(modalResult: ModalSubmitInteraction, coin: CryptoApiData) {\n    if (modalResult.customId == \"alertsmodal\") {\n        const what = modalResult.fields.getTextInputValue(\"alertsmodalstat\").toLowerCase();\n        const when = modalResult.fields.getTextInputValue(\"alertsmodalvalue\");\n        if (!new RegExp(/^\\d+$/).test(when)) {\n            modalResult.reply({ content: \"The threshold you specified was not a number. Make sure to specify **only** the number itself (leave out `%` and `$`)\", ephemeral: true });\n            return;\n        }\n        if (!whatOptions.includes(what)) {\n            modalResult.reply({ content: \"The stat you specified was invalid. Make sure to specify the exact string provided in the example (eg. `1h%` or `price`)\", ephemeral: true });\n            return;\n        }\n        let setting: UserSetting = new UserSetting();\n        setting = new UserSetting();\n        setting.id = modalResult.user.id;\n        setting.type = UserSettingType[UserSettingType.ALERT];\n        setting.alertStat = what;\n        setting.alertThreshold = Number(when);\n        setting.alertToken = coin.id;\n        const manageAlertLink = chatInputApplicationCommandMention(\"managealerts\", (await modalResult.client.application.commands.fetch()).find(command => command.name == \"managealerts\").id);\n        if (Object.values(await db.get(\"select exists(select 1 from user_settings where alertToken=? and alertStat=?)\", coin.id, what))[0]) {\n            modalResult.reply({ content: `You are already tracking the \\`${what}\\` of \\`${coin.name}\\`. You may remove your existing alert with ${manageAlertLink}.`, ephemeral: true });\n            return;\n        }\n        if (Object.values(await db.get(\"select count(id) from user_settings where id=? and type=?\", setting.id, setting.type))[0] >= 10) {\n            modalResult.reply({ content: `You can not have more than 10 active alerts. Please remove one before proceeding. ${manageAlertLink}`, ephemeral: true });\n            return;\n        }\n        await genSqlInsertCommand(setting, \"user_settings\", new UserSetting());\n        modalResult.reply({ content: `Done! Added alert for ${coin.name}. Manage your alerts with ${manageAlertLink}`, ephemeral: true });\n    }\n}\n\nexport async function processButtons(interaction: ButtonInteraction, coin: CryptoApiData) {\n    if (interaction.customId == \"alerts\") {\n        whatOptions.sort((a, b) => a.length - b.length);\n        const modal = new ModalBuilder()\n            .setCustomId(\"alertsmodal\")\n            .setTitle(`Adding Alert for ${coin.name}`)\n            .addComponents(new ActionRowBuilder<TextInputBuilder>().addComponents(new TextInputBuilder()\n                .setCustomId(\"alertsmodalstat\")\n                .setLabel(\"Which stat do you want to track?\")\n                .setStyle(TextInputStyle.Short)\n                .setMaxLength(whatOptions[whatOptions.length - 1].length)\n                .setMinLength(1)\n                .setPlaceholder(whatOptions.join(\", \"))\n                .setRequired(true)))\n            .addComponents(new ActionRowBuilder<TextInputBuilder>().addComponents(new TextInputBuilder()\n                .setCustomId(\"alertsmodalvalue\")\n                .setLabel(\"At what threshold should you be alerted?\")\n                .setStyle(TextInputStyle.Short)\n                .setMaxLength(10)\n                .setMinLength(1)\n                .setPlaceholder(\"20000\")\n                .setRequired(true)));\n        await interaction.showModal(modal);\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        interaction.awaitModalSubmit({ time: 60000, filter: j => j.user.id == interaction.user.id }).then(modalResult => processModals(modalResult, coin)).catch(err => {\n            console.log(err);\n            //i.followUp(\"Alert form timed out. Did you take more than 1 minute to submit?\"); //todo fix this\n        });\n    } else if (interaction.customId == \"setfav\") {\n        if (interaction.component.label == \"Favourite\") {\n            const setting = new UserSetting();\n            setting.id = interaction.user.id;\n            setting.favouriteCrypto = coin.id;\n            setting.type = UserSettingType[UserSettingType.FAVOURITE_CRYPTO];\n            await genSqlInsertCommand(setting, \"user_settings\", new UserSetting());\n        } else {\n            await db.run(\"delete from user_settings where id=? and favouriteCrypto=?\", interaction.user.id, coin.id);\n        }\n        const newComponents = await editComponents(interaction.message, async (builder) => {\n            if (builder instanceof ButtonBuilder) {\n                if ((builder.data as APIButtonComponentWithCustomId).custom_id == \"setfav\") {\n                    return builder.setLabel(builder.data.label == \"Favourite\" ? \"Unfavourite\" : \"Favourite\")\n                        .setStyle(builder.data.label == \"Favourite\" ? ButtonStyle.Secondary : ButtonStyle.Primary);\n                } else {\n                    return builder;\n                }\n            } else if (builder instanceof StringSelectMenuBuilder) {\n                return builder.data.custom_id == \"favCoins\" ? await genFavouritesMenu(interaction) : builder;\n            } else {\n                return builder;\n            }\n        });\n        interaction.update({ embeds: interaction.message.embeds, components: [...newComponents] });\n    }\n}\n"],"names":["chatInputApplicationCommandMention","ActionRowBuilder","ButtonBuilder","ButtonStyle","ModalBuilder","StringSelectMenuBuilder","TextInputBuilder","TextInputStyle","whatOptions","db","genSqlInsertCommand","UserSetting","UserSettingType","editComponents","genFavouritesMenu","processModals","modalResult","coin","customId","what","fields","getTextInputValue","toLowerCase","when","RegExp","test","reply","content","ephemeral","includes","setting","id","user","type","ALERT","alertStat","alertThreshold","Number","alertToken","manageAlertLink","client","application","commands","fetch","find","command","name","Object","values","get","processButtons","interaction","sort","a","b","length","modal","setCustomId","setTitle","addComponents","setLabel","setStyle","Short","setMaxLength","setMinLength","setPlaceholder","join","setRequired","showModal","awaitModalSubmit","time","filter","j","then","catch","err","console","log","component","label","favouriteCrypto","FAVOURITE_CRYPTO","run","newComponents","message","builder","data","custom_id","Secondary","Primary","update","embeds","components"],"mappings":"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"}