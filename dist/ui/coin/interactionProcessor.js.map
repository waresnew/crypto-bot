{"version":3,"sources":["../../../src/ui/coin/interactionProcessor.ts"],"sourcesContent":["import {\n    ActionRowBuilder,\n    ButtonInteraction,\n    chatInputApplicationCommandMention,\n    Message,\n    ModalBuilder,\n    ModalSubmitInteraction,\n    StringSelectMenuInteraction,\n    TextInputBuilder,\n    TextInputStyle\n} from \"discord.js\";\nimport {db, genSqlInsertCommand, idToApiData} from \"../../database.js\";\nimport {CryptoApiData} from \"../../structs/cryptoapidata.js\";\nimport {UserSetting, UserSettingType} from \"../../structs/usersettings.js\";\nimport InteractionProcessor from \"../abstractInteractionProcessor.js\";\nimport {makeButtons, makeEmbed, makeFavouritesMenu} from \"./interfaceCreator.js\";\nimport CryptoStat from \"../../structs/cryptoStat.js\";\n\nexport default class CoinInteractionProcessor extends InteractionProcessor {\n    static override async processModal(interaction: ModalSubmitInteraction): Promise<void> {\n        const coin = await this.getChoiceFromEmbed(interaction.message);\n        if (interaction.customId.startsWith(\"coin_alertsmodal\")) {\n            const what = interaction.fields.getTextInputValue(`coin_alertsmodalstat_${interaction.user.id}`).toLowerCase();\n            const when = interaction.fields.getTextInputValue(`coin_alertsmodalvalue_${interaction.user.id}`);\n            if (when.charAt(0) != \"<\" && when.charAt(0) != \">\") {\n                await interaction.reply({\n                    content: \"The specified threshold did not have a `<` or `>` sign in front of it. Please use `<` if you want to be alerted when the value is below your threshold, and `>` if you want to know when the value is above.\",\n                    ephemeral: true\n                });\n                return;\n            }\n            if (isNaN(Number(when.substring(1))) || isNaN(parseFloat(when.substring(1)))) {\n                await interaction.reply({\n                    content: \"The specified threshold was not a number. Make sure to remove percent and dollar signs from your input.)\",\n                    ephemeral: true\n                });\n                return;\n            }\n            if (!CryptoStat.listShorts().includes(what)) {\n                await interaction.reply({\n                    content: \"The specified stat was invalid. Make sure to specify the exact string provided in the example (eg. `1h%` or `price`)\",\n                    ephemeral: true\n                });\n                return;\n            }\n            const setting = new UserSetting();\n            setting.id = interaction.user.id;\n            setting.type = UserSettingType[UserSettingType.ALERT];\n            setting.alertStat = what;\n            setting.alertThreshold = Number(when.substring(1));\n            setting.alertToken = coin.id;\n            setting.alertDirection = when.charAt(0);\n            const manageAlertLink = chatInputApplicationCommandMention(\"alerts\", (await interaction.client.application.commands.fetch()).find(command => command.name == \"alerts\").id);\n            if ((await db.get(\"select count(id) from user_settings where id=? and type=?\", setting.id, setting.type))[\"count(id)\"] >= 25) {\n                //limit to 25 bc stringselectmenus hax a max of 25 entries\n                await interaction.reply({\n                    content: `You can not have more than 25 alerts set. Please delete one before proceeding. ${manageAlertLink}`,\n                    ephemeral: true\n                });\n                return;\n            }\n            await genSqlInsertCommand(setting, \"user_settings\", new UserSetting());\n            await interaction.reply({\n                content: `Done! Added alert for ${coin.name}. Manage your alerts with ${manageAlertLink}`,\n                ephemeral: true\n            });\n        }\n    }\n\n    static override async processButton(interaction: ButtonInteraction): Promise<void> {\n        const coin = await this.getChoiceFromEmbed(interaction.message);\n        if (interaction.customId.startsWith(\"coin_alerts\")) {\n            const sortedOptions = CryptoStat.listShorts().sort((a, b) => a.length - b.length);\n            const modal = new ModalBuilder()\n                .setCustomId(`coin_alertsmodal_${interaction.user.id}`)\n                .setTitle(`Adding alert for ${coin.name}`)\n                .addComponents(new ActionRowBuilder<TextInputBuilder>().addComponents(new TextInputBuilder()\n                    .setCustomId(`coin_alertsmodalstat_${interaction.user.id}`)\n                    .setLabel(\"Which stat do you want to track?\")\n                    .setStyle(TextInputStyle.Short)\n                    .setMaxLength(sortedOptions[sortedOptions.length - 1].length)\n                    .setMinLength(sortedOptions[0].length)\n                    .setPlaceholder(sortedOptions.join(\", \"))\n                    .setRequired(true)))\n                .addComponents(new ActionRowBuilder<TextInputBuilder>().addComponents(new TextInputBuilder()\n                    .setCustomId(`coin_alertsmodalvalue_${interaction.user.id}`)\n                    .setLabel(\"At what threshold should you be alerted?\")\n                    .setStyle(TextInputStyle.Short)\n                    .setMaxLength(10) //limit so things like float precision don't appear\n                    .setMinLength(2)\n                    .setPlaceholder(\"eg. <-20 for less than -20, >10 for greater than 10\")\n                    .setRequired(true)));\n            await interaction.showModal(modal);\n        } else if (interaction.customId.startsWith(\"coin_setfav\")) {\n            if (interaction.component.label == \"Favourite\") {\n                const setting = new UserSetting();\n                setting.id = interaction.user.id;\n                setting.favouriteCrypto = coin.id;\n                setting.type = UserSettingType[UserSettingType.FAVOURITE_CRYPTO];\n                await genSqlInsertCommand(setting, \"user_settings\", new UserSetting());\n            } else {\n                await db.run(\"delete from user_settings where id=? and favouriteCrypto=?\", interaction.user.id, coin.id);\n            }\n            const newButtons = await makeButtons(coin, interaction);\n            const newMenu = await makeFavouritesMenu(interaction);\n            await interaction.update({embeds: interaction.message.embeds, components: [newButtons, newMenu]});\n        } else if (interaction.customId.startsWith(\"coin_refresh\")) {\n            await interaction.update({\n                components: interaction.message.components,\n                embeds: [await makeEmbed(coin, interaction.client)]\n            });\n        }\n    }\n\n    static override async processStringSelect(interaction: StringSelectMenuInteraction): Promise<void> {\n\n        const selected = interaction.values[0];\n        if (selected == \"default\") {\n            await interaction.reply({content: \"Favourite a coin to add it to the list!\", ephemeral: true});\n            return;\n        }\n        const coin = await idToApiData(selected);\n        await interaction.update({\n            components: interaction.message.components,\n            embeds: [await makeEmbed(coin, interaction.client)]\n        });\n    }\n\n    static async getChoiceFromEmbed(message: Message): Promise<CryptoApiData> {\n        const pictureUrl = message.embeds[0].data.thumbnail.url;\n        const firstToken = \"https://s2.coinmarketcap.com/static/img/coins/128x128/\", secondToken = \".png\";\n        const id = pictureUrl.substring(pictureUrl.indexOf(firstToken) + firstToken.length, pictureUrl.indexOf(secondToken));\n        return await idToApiData(id);\n    }\n}"],"names":["ActionRowBuilder","chatInputApplicationCommandMention","ModalBuilder","TextInputBuilder","TextInputStyle","db","genSqlInsertCommand","idToApiData","UserSetting","UserSettingType","InteractionProcessor","makeButtons","makeEmbed","makeFavouritesMenu","CryptoStat","CoinInteractionProcessor","processModal","interaction","coin","getChoiceFromEmbed","message","customId","startsWith","what","fields","getTextInputValue","user","id","toLowerCase","when","charAt","reply","content","ephemeral","isNaN","Number","substring","parseFloat","listShorts","includes","setting","type","ALERT","alertStat","alertThreshold","alertToken","alertDirection","manageAlertLink","client","application","commands","fetch","find","command","name","get","processButton","sortedOptions","sort","a","b","length","modal","setCustomId","setTitle","addComponents","setLabel","setStyle","Short","setMaxLength","setMinLength","setPlaceholder","join","setRequired","showModal","component","label","favouriteCrypto","FAVOURITE_CRYPTO","run","newButtons","newMenu","update","embeds","components","processStringSelect","selected","values","pictureUrl","data","thumbnail","url","firstToken","secondToken","indexOf"],"mappings":"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"}