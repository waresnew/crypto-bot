{"version":3,"sources":["../src/database.ts"],"sourcesContent":["import sqlite3 from \"sqlite3\";\nimport {Database, open} from \"sqlite\";\nimport path from \"node:path\";\nimport {fileURLToPath} from \"url\";\nimport {CryptoApiData} from \"./structs/cryptoapidata.js\";\nimport {cryptoNameList, cryptoSymbolList} from \"./utils.js\";\nimport {UserSetting} from \"./structs/usersettings.js\";\n\nexport let db: Database = null;\nsqlite3.verbose();\ndb = await open({\n    filename: path.join(path.dirname(fileURLToPath(import.meta.url)), \"..\", \"data\", \"bot.db\"),\n    driver: sqlite3.Database\n});\nawait db.run(\"begin\");\n//init global stats\nawait db.run(\n    \"create table if not exists global_stats(id integer primary key, commands_run_ever integer default 0, unique_user integer default 0)\"\n);\ndb.run(\"insert or ignore into global_stats(id) values(0)\");\n\n//init cmc cache\nawait db.run(\"create table if not exists cmc_cache(dummy bit)\");\nawait genSqlSchema(new CryptoApiData(), \"cmc_cache\");\ndb.run(\"create index if not exists cmc_name_index on cmc_cache(name)\");\ndb.run(\"create index if not exists cmc_symbol_index on cmc_cache(symbol)\");\ndb.run(\"create index if not exists cmc_id_index on cmc_cache(id)\");\n//init user settings\nawait db.run(\"create table if not exists user_settings(dummy bit)\");\nawait genSqlSchema(new UserSetting(), \"user_settings\");\ndb.run(\"create index if not exists settings_id_index on user_settings(id)\");\ndb.run(\"create index if not exists settings_type_index on user_settings(type)\");\nawait db.run(\"commit\");\nawait db.each(\"select symbol,name from cmc_cache\", (err, row) => {\n    if (err) {\n        throw err;\n    }\n    cryptoSymbolList.push(row.symbol);\n    cryptoNameList.push(row.name);\n});\n\n/**assume fields are only type number/string */\nasync function genSqlSchema(dummy: unknown, table: string) {\n    const keys = Object.keys(dummy).filter(key => key != \"dummy\");\n    for (let i = 0; i < keys.length; i++) {\n        const prop = keys[i];\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const type = typeof (dummy as any)[prop];\n        let typeString: string;\n        if (type == \"number\") {\n            typeString = \"decimal\";\n        } else {\n            typeString = \"varchar(65535)\";\n        }\n        try {\n            await db.run(`alter table ${table} add ${prop} ${typeString}`);\n        } catch (err) {\n        }\n    }\n\n}\n\nexport async function genSqlInsertCommand(data: unknown, table: string, dummy: unknown) {\n    const dummyKeys = Object.keys(dummy);\n    let keyString = `insert into ${table} (`;\n    let valueString = \" values(\";\n    const valueParams = [];\n\n    for (let i = 0; i < dummyKeys.length; i++) {\n        valueString += i != 0 ? \", ?\" : \"?\";\n        keyString += i != 0 ? `, ${dummyKeys[i]}` : dummyKeys[i];\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const newData = (data as any)[dummyKeys[i]];\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        valueParams.push(!newData ? (dummy as any)[dummyKeys[i]] : newData);\n    }\n    await db.run(keyString + \")\" + valueString + \")\", valueParams);\n}\n\nexport async function idToApiData(id: number | string) {\n    return await db.get(\"select * from cmc_cache where id=?\", id) as CryptoApiData;\n}"],"names":["sqlite3","open","path","fileURLToPath","CryptoApiData","cryptoNameList","cryptoSymbolList","UserSetting","db","verbose","filename","join","dirname","url","driver","Database","run","genSqlSchema","each","err","row","push","symbol","name","dummy","table","keys","Object","filter","key","i","length","prop","type","typeString","genSqlInsertCommand","data","dummyKeys","keyString","valueString","valueParams","newData","idToApiData","id","get"],"mappings":"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"}